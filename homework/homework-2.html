<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        #refresh {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        #current_time {
            position: absolute;
            right : 20px;
        }

        #map { height: 480px; }

        .refreshdiv { position: relative; padding-top: 20px; }

        .rentrate-green { color : green; }

        .rentrate-orange { color : orange; }

        .rentrate-red { color : red; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="refreshdiv">
        <button id="refresh">更新</button>
        <span id="next_refresh"></span>
        <span id="current_time"></span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js" integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
    <script>
    var map = L.map('map').setView([25.0339145, 121.5412233], 17);
    let current_marker = L.marker([25.0339145, 121.5412233]);
    current_marker.addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // 自訂 Icon 
    var ubikeIcon = L.icon ({
        iconUrl: 'youbike.png',
        iconSize:     [20, 20], // Icon 大小
        iconAnchor:   [10, 10], // 調整 Icon 出現位置
        popupAnchor:  [0, -10] // 調整 popup 視窗出現位置
    });

    let layerGroup = null;
    let arrLayers = [];

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function get_ubike_info () {
        fetch("http://127.0.0.1:5500/youbike", {
            method: "GET"
        }).then(function(response){
            return response.json();
        }).then(function (stationList) {
            for (let station of stationList) {
                let total = station["Quantity"], available = station["available_rent_bikes"];
                let rentrate = (available / total) * 100;
                let rentratecolor;
                if (rentrate > 50) {
                    rentratecolor = "rentrate-green";
                } else if (rentrate > 20) {
                    rentratecolor = "rentrate-orange";
                } else {
                    rentratecolor = "rentrate-red";
                };
                let marker = L.marker([station["latitude"], station["longitude"]],{icon: ubikeIcon});
                marker.bindPopup(`${station["sna"]}  <sapn class = ${rentratecolor}>${station["available_rent_bikes"]}/${station["Quantity"]}</span>`);
                arrLayers.push(marker);
            }
            layerGroup = L.layerGroup(arrLayers);
            layerGroup.addTo(map);
        });

        let date = new Date();
        let hour = date.getHours();
        if (hour < 10) {hour = "0" + hour;}
        let minute = date.getMinutes();
        if (minute < 10) {minute = "0" + minute;}
        let second = date.getSeconds();
        if (second < 10) {second = "0" + second;}
        document.querySelector("#current_time").innerHTML = `上次更新時間： ${hour}：${minute}：${second}`;
        console.log("refreshed");
    }

    async function next_refresh(sec) {
        for (let i = sec; i > 0 ;i--){
            document.querySelector("#next_refresh").innerHTML = `${i} 秒後更新`;
            await sleep(1000)
        }
    }

    async function auto_refresh() {
        while (true) {
            get_ubike_info ();
            await next_refresh(25);
        }
    }

    auto_refresh();
    document.querySelector("#refresh").addEventListener("click", function() {
        get_ubike_info();
    });
    </script>
</body>
</html>