<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>臺北市停車場資訊</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        h1 {
            display: flex;
            justify-content: center;
        }

        .body {
            padding: 5px;
            padding-bottom: 10px;
        }

        #legend {
            border: 1px solid;
            margin-bottom: 10px;
            background-color: #cccccc;
            border-radius: 10px;
        }

        #legend h2 {
            margin-left: 20px;
            margin-bottom: 7px;
            margin-top: 5px;
        }

        #legend div {
            display: flex;
            flex-wrap: wrap;
        }

        #legend p {
            margin: 0;
            padding: 0;
            padding-top: 6px;
        }

        #map {
            height: 550px;
        }

        p.popname {
            margin: 0;
            padding: 0;
        }

        p.popremain {
            margin: 0;
            padding: 0;
            font-weight: 800;
        }

        .refreshdiv {
            position: relative;
            padding-top: 10px;
        }

        #refresh {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        #next_refresh {
            position: absolute;
            right: 20px;
        }

        footer {
            padding: 10px;
            background-color: #dadada;
        }

        footer p {
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <header>
        <h1>台北市停車場資訊</h1>
    </header>

    <div class="body">

        <div id="legend">
            <h2>圖例</h2>
            <div id="points">
                <div id="redpoint">
                    <img src="redpoint.png" width="66px" height="37px">
                    <p>剩餘格位不足</p>
                </div>
                <div id="yellowpoint">
                    <img src="yellowpoint.png" width="66px" height="37px">
                    <p>剩餘格位不足半數</p>
                </div>
                <div id="greenpoint">
                    <img src="greenpoint.png" width="66px" height="37px">
                    <p>剩餘格位足夠</p>
                </div>
                <div id="bluepoint">
                    <img src="bluepoint.png" width="66px" height="37px">
                    <p>目前無法提供即時車位數資訊</p>
                </div>
                <div id="greypoint">
                    <img src="greypoint.png" width="66px" height="37px">
                    <p>無車位數資訊</p>
                </div>
            </div>
            <div id="hascharge" style="position: relative;">
                <img src="greypoint.png" width="66px" height="37px" style="visibility:hidden">
                <img src="hascharge.png" width="50px" height="50px" style="position:absolute;  left: 8px; top:-5px">
                <p>有電車充電座</p>
            </div>
        </div>
        <div id="map"></div>
        <div class="refreshdiv">
            <span id="next_refresh"></span>
            <button id="refresh">更新</button>
            <span id="current_time"></span>
        </div>
    </div>
    <footer>
        <p>資料來源</p>
        <p>停車場資訊 ： https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_alldesc.json</p>
        <p>空位即時資訊 ： https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_allavailable.json</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
        integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script>
        var map = L.map('map').setView([25.0339145, 121.5412233], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let layerGroup_blue, layerGroup_green, layerGroup_grey, layerGroup_red, layerGroup_yellow = null;
        let arrLayers_blue = [];
        let arrLayers_green = [];
        let arrLayers_grey = [];
        let arrLayers_red = [];
        let arrLayers_yellow = [];

        let layerControl = null;
        let currentOverlayLayers = {};
        layerControl = L.control.layers(null, {}).addTo(map);

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function get_park_info() {
            // 清空舊資料 (以免疊加)
            arrLayers_blue = [];
            arrLayers_green = [];
            arrLayers_grey = [];
            arrLayers_red = [];
            arrLayers_yellow = [];

            Promise.all([
                fetch("https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_alldesc.json").then(r => r.json()),
                fetch("https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_allavailable.json").then(r => r.json())
            ])
                .then(([descData, availData]) => {

                    const park_list = descData.data.park;
                    const remain_list = availData.data.park;

                    // 空位查表 (id -> data)
                    const remainMap = new Map(remain_list.map(i => [i.id, i]));

                    // 合併資料
                    const merged_list = park_list.map(p => ({
                        ...p,
                        available_info: remainMap.get(p.id) || null
                    }));

                    return merged_list;
                })
                .then(function (merged_park_info) {

                    // 座標轉換定義
                    const TWD97 = "+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs";
                    const WGS84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";

                    var PointIcon = L.Icon.extend({
                        options: {
                            iconSize: [66, 37],
                            iconAnchor: [32, 38],
                            popupAnchor: [1, -37]
                        }
                    });

                    var redpoint = new PointIcon({ iconUrl: 'redpoint.png' }),
                        yellowpoint = new PointIcon({ iconUrl: 'yellowpoint.png' }),
                        greenpoint = new PointIcon({ iconUrl: 'greenpoint.png' }),
                        bluepoint = new PointIcon({ iconUrl: 'bluepoint.png' }),
                        greypoint = new PointIcon({ iconUrl: 'greypoint.png' });

                    var hascharge = L.icon({
                        iconUrl: 'hascharge.png',
                        iconSize: [50, 50],
                        iconAnchor: [25, 50]
                    });

                    // 建立 marker
                    for (let park of merged_park_info) {

                        let tw97x = parseFloat(park.tw97x);
                        let tw97y = parseFloat(park.tw97y);

                        if (!tw97x || !tw97y) continue;

                        let [lng, lat] = proj4(TWD97, WGS84, [tw97x, tw97y]);

                        let remain;
                        let rate;

                        if (park.available_info) {
                            remain = park.available_info.availablecar;
                            if (remain >= 0) rate = remain / park.totalcar;
                        }

                        // --- 分類 ---
                        let targetArr;
                        let targetIcon;

                        if (!park.available_info) {
                            targetArr = arrLayers_grey;
                            targetIcon = greypoint;
                        } else if (remain == -9) {
                            targetArr = arrLayers_blue;
                            targetIcon = bluepoint;
                        } else if (remain == -13 || rate < 0.2) {
                            targetArr = arrLayers_red;
                            targetIcon = redpoint;
                        } else if (remain == -12 || rate < 0.5) {
                            targetArr = arrLayers_yellow;
                            targetIcon = yellowpoint;
                        } else {
                            targetArr = arrLayers_green;
                            targetIcon = greenpoint;
                        }

                        let marker = L.marker([lat, lng], { icon: targetIcon });
                        marker.bindPopup(`<p class="popname">${park.name}</p><p class="popremain">剩餘車位：${remain}</p>`);
                        targetArr.push(marker);

                        if (park.available_info && park.available_info.ChargeStation) {
                            let chargeMarker = L.marker([lat, lng], { icon: hascharge });
                            chargeMarker.bindPopup(`<p class="popname">${park.name}</p><p class="popremain">剩餘車位：${remain}</p>`);
                            targetArr.push(chargeMarker);
                        }
                    }

                    let newOverlay = {
                        "剩餘格位不足": L.layerGroup(arrLayers_red),
                        "剩餘格位不足半數": L.layerGroup(arrLayers_yellow),
                        "剩餘格位足夠": L.layerGroup(arrLayers_green),
                        "目前無即時資訊": L.layerGroup(arrLayers_blue),
                        "無車位數資訊": L.layerGroup(arrLayers_grey)
                    };

                    // ----------- ✨ 重點：更新 overlay，不重建控制器 ✨ -----------

                    // 移除舊 overlay
                    for (let name in currentOverlayLayers) {
                        layerControl.removeLayer(currentOverlayLayers[name]);
                        map.removeLayer(currentOverlayLayers[name]);  // 從地圖上也拿掉
                    }

                    // 加入新 overlay
                    for (let name in newOverlay) {
                        currentOverlayLayers[name] = newOverlay[name];
                        layerControl.addOverlay(newOverlay[name], name);
                        newOverlay[name].addTo(map);  // 自動顯示
                    }

                });

            // 更新時間顯示
            let date = new Date();
            let h = String(date.getHours()).padStart(2, '0');
            let m = String(date.getMinutes()).padStart(2, '0');
            let s = String(date.getSeconds()).padStart(2, '0');
            document.querySelector("#current_time").innerHTML = `上次更新： ${h}:${m}:${s}`;
        }


        async function next_refresh(sec) {
            for (let i = sec; i > 0; i--) {
                document.querySelector("#next_refresh").innerHTML = `${i} 秒後更新`;
                await sleep(1000)
            }
        }

        async function auto_refresh() {
            while (true) {
                get_park_info();
                await next_refresh(25);
            }
        }

        auto_refresh();
        document.querySelector("#refresh").addEventListener("click", function () {
            get_park_info();
        });
    </script>
</body>

</html>